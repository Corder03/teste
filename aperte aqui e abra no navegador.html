<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Lâmpada Interativa</title>
  <style>
    body {
      margin: 0;
      background-color: #111;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
      position: relative;
    }

    .lampada-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .mensagem {
      color: white;
      font-size: 36px;
      margin-bottom: 20px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .lampada-container.ligada .mensagem {
      opacity: 1;
    }

    .lampada {
      width: 160px;
      height: 200px;
      background: radial-gradient(ellipse at center, #333 60%, #222 100%);
      border-radius: 50% 50% 40% 40%;
      margin: 0 auto;
      position: relative;
      transition: background 0.3s, box-shadow 0.3s;
      box-shadow: inset -16px -20px 40px rgba(0, 0, 0, 0.6);
      z-index: 2;
    }

    .lampada::before {
      content: "";
      position: absolute;
      top: 20px;
      left: 30px;
      width: 100px;
      height: 120px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.4), transparent);
      border-radius: 50%;
      pointer-events: none;
    }

    .lampada::after {
      content: "";
      position: absolute;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 40px;
      background: linear-gradient(#555, #888);
      border-radius: 10px;
    }

    .lampada.ligada {
      background: radial-gradient(ellipse at center, #ffffff 40%, #dddddd 100%);
      box-shadow: 0 0 200px 80px rgba(255, 255, 255, 0.5),
                  inset -10px -20px 40px rgba(255, 255, 255, 0.5);
    }

    canvas {
      position: absolute;
      left: 50%;
      top: 200px;
      transform: translateX(-50%);
      pointer-events: none;
    }

    .corda-bolinha {
      width: 80px;
      height: 80px;
      background: #444;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      cursor: pointer;
      user-select: none;
    }

    .corda-bolinha span {
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .aviso {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: #ff5555;
      font-size: 14px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 100;
    }

    .instrucoes {
      position: fixed;
      top: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: #0cf;
      font-size: 16px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body>

  <div class="instrucoes">Puxe o cordão para ligar/desligar a lâmpada</div>

  <div id="container" class="lampada-container">
    <div class="mensagem">Luz acesa!</div>
    <div id="lampada" class="lampada"></div>
    <canvas id="corda" width="6" height="600"></canvas>
    <div id="puxador" class="corda-bolinha" style="top:360px;">
      <span>puxe</span>
    </div>
  </div>

  <div id="aviso" class="aviso"></div>

  <script>
    // Elementos DOM
    const lampada = document.getElementById("lampada");
    const container = document.getElementById("container");
    const canvas = document.getElementById("corda");
    const ctx = canvas.getContext("2d");
    const puxador = document.getElementById("puxador");
    const aviso = document.getElementById("aviso");

    // Variáveis de estado
    let puxando = false;
    let puxada = 200;
    const alturaMin = 200;
    const alturaMax = 600;
    let lanternaLigada = false;

    // Configuração da corda física
    const cordaSegmentos = 50;
    const pontos = new Array(cordaSegmentos).fill(0).map(() => ({ y: 0, vy: 0 }));

    // Verificar suporte para lanterna
    const temSuporteLanterna = 'torch' in navigator.mediaDevices || 
                             (navigator.mediaDevices.getSupportedConstraints && 
                              'torch' in navigator.mediaDevices.getSupportedConstraints());

    let stream = null;
    let track = null;

    // Função para mostrar avisos temporários
    function mostrarAviso(texto, tempo = 3000) {
      aviso.textContent = texto;
      aviso.style.display = 'block';
      setTimeout(() => {
        aviso.style.display = 'none';
      }, tempo);
    }

    // Função para ligar a lanterna
    async function ligarLanterna() {
      if (!temSuporteLanterna) {
        mostrarAviso("Seu navegador não suporta controle de lanterna");
        return false;
      }

      try {
        // Solicitar acesso à câmera traseira
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            torch: true
          }
        });
        
        track = stream.getVideoTracks()[0];
        
        // Verificar se tem suporte a lanterna
        if (track.getCapabilities().torch) {
          await track.applyConstraints({
            advanced: [{torch: true}]
          });
          lanternaLigada = true;
          mostrarAviso("Lanterna ativada!", 2000);
          return true;
        } else {
          mostrarAviso("Este dispositivo não permite controle da lanterna");
          return false;
        }
      } catch (err) {
        // Tratamento de erros específicos
        if (err.name === 'NotAllowedError') {
          mostrarAviso("Permissão negada! Você precisa permitir o acesso à câmera.");
        } else if (err.name === 'NotFoundError') {
          mostrarAviso("Nenhuma câmera traseira encontrada");
        } else {
          mostrarAviso("Erro ao acessar lanterna: " + err.message);
        }
        return false;
      }
    }

    // Função para desligar a lanterna
    async function desligarLanterna() {
      if (track && track.getCapabilities().torch) {
        try {
          await track.applyConstraints({
            advanced: [{torch: false}]
          });
          lanternaLigada = false;
        } catch (err) {
          console.error("Erro ao desligar lanterna:", err);
        }
      }
      
      // Liberar recursos
      if (track) {
        track.stop();
        track = null;
      }
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    // Função para desenhar a corda
    function desenharCorda() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.moveTo(3, 0);
      for (let i = 0; i < cordaSegmentos; i++) {
        ctx.lineTo(3, pontos[i].y);
      }
      ctx.strokeStyle = "white";
      ctx.lineWidth = 6;
      ctx.stroke();
    }

    // Animação da corda
    function animar() {
      for (let i = 0; i < cordaSegmentos; i++) {
        const targetY = (i / cordaSegmentos) * puxada;
        const ponto = pontos[i];
        const dy = targetY - ponto.y;
        ponto.vy += dy * 0.1;
        ponto.vy *= 0.85;
        ponto.y += ponto.vy;
      }

      puxador.style.top = (pontos[cordaSegmentos - 1].y + 200 - 40) + "px";
      canvas.height = pontos[cordaSegmentos - 1].y + 80;
      desenharCorda();
      requestAnimationFrame(animar);
    }

    // Funções para interação com o puxador
    function iniciarPuxada(y) {
      puxando = true;
    }

    function moverPuxada(y) {
      if (puxando) {
        const distancia = Math.min(alturaMax, Math.max(alturaMin, y - canvas.getBoundingClientRect().top));
        puxada = distancia;
      }
    }

    async function soltar() {
      if (puxando) {
        puxando = false;
        puxada = alturaMin;
        
        // Alternar estado da lâmpada
        const estavaLigada = lampada.classList.contains("ligada");
        lampada.classList.toggle("ligada");
        container.classList.toggle("ligada");
        
        // Controlar lanterna real
        if (!estavaLigada) {
          await ligarLanterna();
        } else {
          await desligarLanterna();
        }
      }
    }

    // Event listeners para mouse
    puxador.addEventListener("mousedown", (e) => iniciarPuxada(e.clientY));
    document.addEventListener("mousemove", (e) => moverPuxada(e.clientY));
    document.addEventListener("mouseup", soltar);

    // Event listeners para touch
    puxador.addEventListener("touchstart", (e) => {
      e.preventDefault();
      iniciarPuxada(e.touches[0].clientY);
    }, { passive: false });

    document.addEventListener("touchmove", (e) => {
      e.preventDefault();
      moverPuxada(e.touches[0].clientY);
    }, { passive: false });

    document.addEventListener("touchend", soltar);

    // Iniciar animação
    animar();

    // Verificar HTTPS
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      mostrarAviso("Para a lanterna funcionar, acesse via HTTPS", 5000);
    }
  </script>

</body>
</html>